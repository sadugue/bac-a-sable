<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
        <meta charset="UTF-8">
        <link href="style1.css" rel="stylesheet"/>
        <script src="dependances/d3.js"></script>
        <link href="dependances/nv.d3.min.css" rel="stylesheet">
        <script src="dependances/nv.d3.min.js"></script>
        <title>Suivis du prix des fruits et légumes</title>
    </head>
    <body>
        <div class="Sec1">
                <h1>Suivis du prix des fruits et légumes</h1>
        </div>
        <div class="Sec1">
            <div class="Sec2">
                <div class="Sec3">
                    <div class="Ensemble">
                        <label for="start">Date de début:</label>
                        <input type="date" id="start" name="trip-start"
                        value="2023-05-15"
                        min="2003-01-01" max="2023-05-15">
                    </div>
                </div>
                <div class="Sec3">
                    <div class="Ensemble">
                        <label for="stop">Date de fin:</label>
                        <input type="date" id="stop" name="trip-start"
                        value="2023-05-15"
                        min="2003-01-01" max="2023-05-15">
                    </div>
                </div>
            </div>
            <div class="Sec2">
                <div class="Sec3">
                    <div class="Ensemble">
                        <label id="Produit">Produits :</label>
                        <select name="Choix1" id="Ch1">
                            <option value="">--Tous les produits--</option>
                            <option class="Produit"  value="Bananes">Bananes</option>
                        </select>
                    </div>
                </div>
                <div class="Sec3">
                    <div class="Ensemble">
                        <label id="Achats/Ventes">Achats/Ventes :</label>
                        <select name="Choix2" id="Ch2">
                            <option value="">--Achat et Vente--</option>
                            <option class="Achats/Ventes"  value="Achats">Achats</option>
                            <option class="Achats/Ventes"  value="Ventes">Ventes</option>
                        </select>
                    </div>
                </div>
                <div class="Sec3">
                    <div class="Ensemble">
                        <label id="Regions">Régions :</label>
                        <select name="Choix3" id="Ch3">
                            <option value="">--Toutes--</option>
                            <option class="Regions"  value="Europe">Europe</option>
                            <option class="Regions"  value="Afrique">Afrique</option>
                            <option class="Regions"  value="Amerique Latine">Amerique Latine</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="Sec2">
                <div class="Sec3">
                    <div class="Ensemble">
                        <label id="Graphiques">Graphiques :</label>
                        <select name="Choix4" id="Ch4">
                            <option value="">--Sélection--</option>
                            <option class="Graphiques"  value="Graphiques1">Graphiques1</option>
                            <option class="Graphiques"  value="Graphiques2">Graphiques2</option>
                            <option class="Graphiques"  value="Graphiques3">Graphiques3</option>
                        </select>
                    </div>
                </div>
                <div class="Sec3">
                    <div class="Ensemble">
                    <!--Destiné à changer sera juste le resultat donnée par machine e-learning après sa conception ICI-->
                        <label id="Satisfaction">Satisfaction client pour ce prix :</label>
                        <form oninput="result.value=parseInt(b.value)">
                            <input type="range" name="b" value="1" />
                            <output name="result" >5</output>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="Sec1" id="chart">
            <!--Objet graphique après sa conception ICI-->
            <svg></svg>
        </div>

        <script>
            // Graphique n'utilisant pas de fichier en entrée mais affiche 2 courbes.
            // Graphique utilisant fichier en entrée et affiche 2 courbes depuis csv.
            let eachyears = new Array();

function getYear(dateString) {
  var dateParts = dateString.split('-');
  var year = dateParts[2];
  var lastTwoDigits = year.slice(-2);
  return lastTwoDigits;
}

function getUniqueYears(csvData, columnName, callback) {
  const years = new Set();
  const rows = csvData.split('\n');
  const headers = rows[0].split(',');
  const columnIndex = headers.indexOf(columnName);
  for (let i = 1; i < rows.length; i++) {
    const rowData = rows[i].split(',');
    const dateString = rowData[columnIndex];
    if (dateString) {
      const year = dateString.slice(-2);
      years.add(year);
    }
  }
  callback(Array.from(years));
}

d3.csv("bananas-wholesale-prices_en.csv", function(data) {
  nv.addGraph(function() {
    var chart = nv.models.lineChart();
    const csvFilePath = 'bananas-wholesale-prices_en.csv';
    const columnName = 'ending on';

    fetch(csvFilePath)
      .then(response => response.text())
      .then(csvData => {
        getUniqueYears(csvData, columnName, (uniqueYears) => {
          for (var i = 0; i < uniqueYears.length; i++) {
            eachyears[i] = uniqueYears[i];
          }

            function Data(key, values) {
                this.key = key;
                this.values = values;
            }

            var seriesKeys = Object.keys(data[0]).filter(function(key) {
                return /*key !== 'ending on' && */key !== 'week';
            });
            var xValues = data.map(function(d) {
                return +d['week']; // Utiliser les valeurs de la colonne 'week' comme axe des x
            });
                    
            var seriesData = [];
                    for (var i = 0; i < eachyears.length; i++) {
                        for (var j = 1; j < seriesKeys.length; j++) {
                            seriesData.push({
                                key: seriesKeys[j] + ' ' + eachyears[i],
                                values: []
                            });
                        }
                    }
                    var week52Reached = false;
                    var dateprec;
                    var yearprec;
                    data.forEach(function(d) {
                        var i=0;
                        var week = +d['week'];
                        var date1 = d[seriesKeys[0]];
                        var year1 = date1.slice(-2);
                        var value1 = +d[seriesKeys[1]];
                        var value2 = +d[seriesKeys[2]];
                        console.log(year1);
                    if (dateprec!==date1) {
                            /*seriesData[0].values.push({ x: week, y: value1 });
                            seriesData[1].values.push({ x: week, y: value2 });*/
                        if (yearprec === year1) {
                            seriesData[0].values.push({ x: week, y: value1 });
                            seriesData[1].values.push({ x: week, y: value2 });
                        }
                        dateprec=date1;
                        yearprec = year1;
                    }
                    /*for (var i = 0; i < eachyears.length; i++){
                        var a=1;
                        if (a<52){
                            seriesData[0].values.push({ x: week, y: value1 });
                            seriesData[1].values.push({ x: week, y: value2 });
                        }
                        a++;
                    }*/
                    });
                    
                    chart.xAxis
                        .axisLabel('Semaines');
        
                    chart.yAxis
                        .axisLabel('Prix au 100 kilos');
        
                    d3.select('#chart svg')
                        .datum(seriesData)
                        .transition().duration(500)
                        .call(chart);
        
                    nv.utils.windowResize(function() {
                        chart.update();
                    });
                    return chart;
                });

        });
      })
      .catch(error => {
        console.error('Erreur lors du chargement du fichier CSV :', error);
      });
  });
        </script>
        
    </body>
</html>
