<!DOCTYPE html>
<html lang="fr">

<head>
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <meta charset="UTF-8">
    <title>Suivis du prix des fruits et légumes</title>
    <link href="style1.css" rel="stylesheet" />
    <script src="d3.js"></script>
    <link href="nv.d3.min.css" rel="stylesheet">
    <script src="nv.d3.min.js"></script>

    <script src="fichecsv.js"></script>

</head>

<body>
    <div class="Sec1">
        <h1>Suivis du prix des fruits et légumes</h1>
    </div>
    <div class="Sec1">
        <div class="Sec2">
            <form id="dateForm" onsubmit="event.preventDefault();">
                <div class="Sec3">
                    <div class="Ensemble">
                        <label for="start">Date de début:</label>
                        <input type="date" id="start" required name="trip-start" value="2023-05-15" min="2003-01-01"
                            max="2023-05-15">
                    </div>
                </div>
                <div class="Sec3">
                    <div class="Ensemble">
                        <label for="stop">Date de fin:</label>
                        <input type="date" id="stop" required name="trip-stop" value="2023-05-15" min="2003-01-01"
                            max="2023-05-15">
                    </div>
                </div>
                <div class="Sec3">
                    <div class="Ensemble">
                        <button type="submit">Afficher</button>
                        <div id="errorMessage" style="color: silver; font-weight: bold;">
                            <p id="error"></p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="Sec2">
            <div class="Sec3">
                <div class="Ensemble">
                    <label id="Produit">Produits :</label>
                    <select name="Choix1" id="Ch1" onchange="change()">
                        <option value="">--Tous les produits--</option>
                        <option class="Produit" value="bananas-wholesale-prices_en.csv">Bananes</option>
                        <option class="Produit" value="Pommes">Pommes</option>
                    </select>
                </div>
            </div>
            <div class="Sec3">
                <div class="Ensemble">
                    <label id="Achats/Ventes">Achats/Ventes :</label>
                    <select name="Choix2" id="Ch2">
                        <option value="">--Achat et Vente--</option>
                        <option class="Achats/Ventes" value="Achats">Achats</option>
                        <option class="Achats/Ventes" value="Ventes">Ventes</option>
                    </select>
                </div>
            </div>
            <div class="Sec3">
                <div class="Ensemble">
                    <label id="Regions">Régions :</label>
                    <select name="Choix3" id="Ch3">
                        <option value="">--Toutes--</option>
                        <option class="Regions" value="Europe">Europe</option>
                        <option class="Regions" value="Afrique">Afrique</option>
                        <option class="Regions" value="Amerique Latine">Amerique Latine</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="Sec2">
            <div class="Sec3">
                <div class="Ensemble">
                    <label id="Graphiques">Graphiques :</label>
                    <select name="Choix4" id="Ch4">
                        <option value="">--Sélection--</option>
                        <option class="Graphiques" value="Graphiques1">Graphiques1</option>
                        <option class="Graphiques" value="Graphiques2">Graphiques2</option>
                        <option class="Graphiques" value="Graphiques3">Graphiques3</option>
                    </select>
                </div>
            </div>
            <div class="Sec3">
                <div class="Ensemble">
                    <label id="Satisfaction">Satisfaction client pour ce prix :</label>
                    <input type="range" id="slider" min="1" max="10" value="5">
                    <span id="sliderValue">5</span>
                </div>
            </div>
        </div>
    </div>
    <div class="Sec1" id="chart">
        <svg></svg>
    </div>

    <script>
        // Graphique n'utilisant pas de fichier en entrée mais affiche 2 courbes.
        // Graphique utilisant fichier en entrée et affiche 2 courbes depuis csv.
        let eachyears = new Array();
        var graph = '';

        function Clique() {
            graph = document.getElementById("Ch4").value;
        }

        if (graph === "Graphiques1") {  // Remplissage de la valeur manquante dans la condition if
            function getYear(dateString) {
                dateString = dateString.toString();
                if (typeof dateString === 'string') {
                    var dateParts = dateString.split('-');
                    var year = dateParts[2];
                    var lastTwoDigits = year.slice(-2);
                    return lastTwoDigits;
                }
                return null; // ou une valeur par défaut si la chaîne de caractères est invalide
            }

            function getMonth(dateString) {
                dateString = dateString.toString();
                if (typeof dateString === 'string') {
                    var dateParts = dateString.split('-');
                    var year = dateParts[1];
                    var lastTwoDigits = year.slice(-2);
                    return lastTwoDigits;
                }
                return null; // ou une valeur par défaut si la chaîne de caractères est invalide
            }

            function getDay(dateString) {
                dateString = dateString.toString();
                if (typeof dateString === 'string') {
                    var dateParts = dateString.split('-');
                    var year = dateParts[0];
                    var lastTwoDigits = year.slice(-2);
                    return lastTwoDigits;
                }
                return null; // ou une valeur par défaut si la chaîne de caractères est invalide
            }

            function getUniqueYears(csvData, columnName, callback) {
                const years = new Set();
                const rows = csvData.split('\n');
                const headers = rows[0].split(',');
                const columnIndex = headers.indexOf(columnName);
                for (let i = 1; i < rows.length; i++) {
                    const rowData = rows[i].split(',');
                    const dateString = rowData[columnIndex];
                    if (dateString) {
                        const year = dateString.slice(-2);
                        years.add(year);
                    }
                }
                callback(Array.from(years));
            }

            d3.csv("bananas-wholesale-prices_en.csv", function(data) {
                nv.addGraph(function() {
                    var chart = nv.models.lineChart();
                    const csvFilePath = 'bananas-wholesale-prices_en.csv';
                    const columnName = 'ending on';
                    fetch(csvFilePath)
                        .then(response => response.text())
                        .then(csvData => {
                            getUniqueYears(csvData, columnName, (uniqueYears) => {
                                for (var i = 0; i < uniqueYears.length; i++) {
                                    eachyears[i] = uniqueYears[i];
                                }
      
                                function Data(key, values) {
                                    this.key = key;
                                    this.values = values;
                                }

                                var seriesKeys = Object.keys(data[0]).filter(function(key) {
                                    return key !== 'ending on' && key !== 'week';
                                });

                                var seriesData = [];
                                for (var i = 0; i < eachyears.length; i++) {
                                    for (var j = 0; j < seriesKeys.length; j++) {
                                        var countryData = data.filter(function(d) {
                                            return getYear(d['ending on']) === eachyears[i] /*&& d['country'] === seriesKeys[j]*/;
                                        });
                                        var values = countryData.map(function(d) {
                                            return { x: +d['week'], y: +d[seriesKeys[j]] };
                                        });
                                        seriesData.push({
                                            key: seriesKeys[j] + ' ' + eachyears[i],
                                            values: values
                                        });
                                    }
                                }
    
                                chart.xAxis.axisLabel('Semaines');
                                chart.yAxis.axisLabel('Prix au 100 kilos');
    
                                d3.select('#chart svg')
                                    .datum(seriesData)
                                    .transition().duration(500)
                                    .call(chart);
    
                                nv.utils.windowResize(function() {
                                    chart.update();
                                });

                                return chart;
                            });
                        });
                });
            });
        }
    </script>
</body>
</html>


